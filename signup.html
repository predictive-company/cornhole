<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - Cornhole Kings</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #080a14;
      color: white;
      overflow-x: hidden;
      background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('img/background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .auth-container {
      width: 100%;
      max-width: 350px; /* Reduced from 400px to match login page */
      padding: 1rem;
    }
    
    .auth-card {
      background: #1a1b26; /* Darker background to match login page */
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      text-align: center; /* Center all content */
    }
    
    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
    }
    
    .logo a {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: white;
    }
    
    .logo img {
      width: 50px;
      height: 50px;
    }
    
    .logo h1 {
      margin: 0;
      font-size: 1.8rem;
      color: white;
    }
    
    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: white;
      font-size: 1.75rem;
    }
    
    .auth-field {
      margin-bottom: 1.2rem;
      text-align: left;
    }
    
    .auth-field label {
      display: block;
      margin-bottom: 0.5rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .auth-field input {
      width: 100%;
      padding: 0.75rem;
      border-radius: 6px;
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      box-sizing: border-box;
      transition: all 0.2s;
    }
    
    .auth-field input:focus {
      outline: none;
      border-color: #4ade80;
      background-color: rgba(255, 255, 255, 0.08);
    }
    
    .auth-field small {
      display: block;
      margin-top: 0.5rem;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.8rem;
    }
    
    .error-message {
      color: #e74c3c;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    
    .auth-button {
      width: 100%;
      padding: 0.8rem 0;
      background-color: #4ade80;
      color: #080a14;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .auth-button:hover {
      background-color: #22c55e;
    }
    
    .auth-footer {
      text-align: center;
      margin-top: 1.5rem;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }
    
    .auth-footer a {
      color: #4ade80;
      text-decoration: none;
      font-weight: bold;
      transition: color 0.2s;
    }
    
    .auth-footer a:hover {
      color: #22c55e;
      text-decoration: underline;
    }
    
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      background-color: rgba(74, 222, 128, 0.9);
      color: white;
      border-radius: 6px;
      display: none;
      z-index: 1000;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-card">
      <div class="logo">
        <a href="index.html">
          <img src="img/outline.png" alt="Cornhole Kings Logo">
          <h1>Cornhole Kings</h1>
        </a>
      </div>
      
      <h2>Create Account</h2>
      
      <form id="signupForm" autocomplete="off">
        <div class="auth-field">
          <label for="name">Full Name</label>
          <input type="text" id="name" required>
        </div>
        
        <div class="auth-field">
          <label for="username">Username</label>
          <input type="text" id="username" required>
          <small>Choose a unique username</small>
        </div>
        
        <div class="auth-field">
          <label for="email">Email</label>
          <input type="email" id="email" required>
        </div>
        
        <div class="auth-field">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required minlength="6" autocomplete="new-password" inputmode="text" pattern=".{6,}" autocapitalize="none">
          <small>Password must be at least 6 characters</small>
        </div>
        
        <div id="errorMessage" class="error-message"></div>
        
        <button type="submit" class="auth-button">Create Account</button>
      </form>
      
      <p class="auth-footer">
        Already have an account? <a href="login.html">Sign In</a>
      </p>
    </div>
  </div>
  
  <div id="toast"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    // Initialize Supabase client directly in the page
    const supabaseUrl = 'https://ungxxrxwfbftlcsrmexl.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZ3h4cnh3ZmJmdGxjc3JtZXhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA3NTQ2MjAsImV4cCI6MjA1NjMzMDYyMH0.mpZepE3mgF4EMNIoe2k5_7LhNLWqAwv7se1amsHLYiA';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    // Define signupUser function that matches your existing schema
    async function signupUser(email, password, metadata = {}) {
      try {
        // First, create the auth user
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: metadata,
            emailRedirectTo: `${window.location.origin}/login.html?verified=true`
          }
        });
        
        if (error) {
          console.error("Auth signup error:", error);
          return { data, error };
        }
        
        console.log("Auth signup successful", data);
        
        // Then create a profile in the profiles table if the user was created
        if (data && data.user) {
          const userId = data.user.id;
          console.log("Creating profile for user ID:", userId);
          
          // Create profile data that matches your schema (without full_name)
          const profileData = {
            id: userId,
            username: metadata.username || '',
            email: email,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            is_admin: false
          };
          
          console.log("Profile data to insert:", profileData);
          
          // Create the profile record
          const { data: profileResult, error: profileError } = await supabase
            .from('profiles')
            .insert([profileData])
            .select();
            
          if (profileError) {
            console.error("Error creating profile:", profileError);
          } else {
            console.log("Profile created successfully", profileResult);
          }
        }
        
        return { data, error: null };
      } catch (err) {
        console.error('Signup error:', err);
        return { data: null, error: err };
      }
    }
    
    // Function to check if username exists
    async function checkUsernameExists(username) {
      try {
        const { data, error } = await supabase
          .from('profiles')
          .select('id')
          .eq('username', username);
          
        if (error) {
          throw error;
        }
        
        return data && data.length > 0;
      } catch (err) {
        console.error('Check username error:', err);
        return false;
      }
    }
  </script>
  <script src="js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const signupForm = document.getElementById('signupForm');
      const errorMessage = document.getElementById('errorMessage');
      
      signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('name').value;
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        // Username validation
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
          errorMessage.textContent = 'Username can only contain letters, numbers, and underscores';
          return;
        }
        
        try {
          // Check if username already exists
          const usernameExists = await checkUsernameExists(username);
          
          if (usernameExists) {
            errorMessage.textContent = 'Username already taken. Please choose another one.';
            return;
          }
          
          // Show a message that we're creating the account
          errorMessage.textContent = '';
          showToast('Creating your account...', 'info');
          
          // Proceed with signup - storing name in user metadata
          const { data, error } = await signupUser(email, password, { 
            full_name: name,
            username: username
          });
          
          if (error) {
            errorMessage.textContent = error.message;
          } else {
            showToast('Account created successfully! Please check your email to confirm your account.');
            // Redirect to login page after successful signup
            setTimeout(() => {
              window.location.href = 'login.html?verified=pending';
            }, 3000);
          }
        } catch (err) {
          errorMessage.textContent = 'An unexpected error occurred. Please try again.';
          console.error('Signup error:', err);
        }
      });
    });
    
    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      
      // Set different background colors for different message types
      if (type === 'success') {
        toast.style.backgroundColor = 'rgba(74, 222, 128, 0.9)';
      } else if (type === 'error') {
        toast.style.backgroundColor = 'rgba(231, 76, 60, 0.9)';
      } else if (type === 'info') {
        toast.style.backgroundColor = 'rgba(52, 152, 219, 0.9)';
      }
      
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>