<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9MBYREN71N"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9MBYREN71N');
  </script>
    
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
  <link rel="manifest" href="/img/site.webmanifest">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - Cornhole Kings</title>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

:root {
  --primary: #FE53BB;      /* Hot pink */
  --primary-light: #FF7CD8;
  --secondary: #08F7FE;    /* Neon blue */
  --secondary-light: #5FFBFF;
  --accent: #F5D300;       /* Electric yellow */
  --dark: #240046;         /* Deep purple */
  --darker: #190032;
  --text: #FFFFFF;
  --text-muted: rgba(255, 255, 255, 0.7);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: 'Poppins', sans-serif;
  color: var(--text);
  overflow-x: hidden;
  position: relative;
  background-color: #080a14;
  line-height: 1.6;
  -webkit-overflow-scrolling: touch;
}

/* Add a pseudo-element that contains both the background image and the darkening overlay */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('img/background.jpg');
  background-size: cover;
  background-attachment: fixed;
  background-position: center;
  /* This creates a dark overlay on top of your image */
  box-shadow: inset 0 0 0 2000px rgba(0, 0, 0, 0.65);
  z-index: -1;
}

/* Header and Nav */
header {
  background-color: rgba(11, 12, 30, 0.8);
  backdrop-filter: blur(10px);
  padding: 0.7rem 2rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  width: 100%;
  box-sizing: border-box;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* Left section - Logo */
.logo-section {
  display: flex;
  align-items: center;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
}

.logo h1 {
  margin: 0;
  font-size: 2.0rem;
  font-weight: 700;
  color: white; 
  text-shadow: 0 0 10px rgba(138, 43, 226, 0.5); 
}

.logo-icon {
  width: 36px;
  height: 36px;
  background-color: #f1c40f; /* Keep original color */
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
  color: #0d1023;
  position: relative;
  overflow: hidden;
}

/* Middle section - Navigation */
.nav-section {
  display: flex;
  justify-content: center;
  flex: 1;
}

nav {
  display: flex;
  background: rgba(11, 12, 30, 0.4);
  border-radius: 4px;
  padding: 0.2rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

nav a {
  color: var(--text);
  text-decoration: none;
  padding: 0.6rem 1rem;
  font-weight: 800;
  transition: color 0.2s, background-color 0.2s;
  font-size: 1.1rem;
  border-radius: 4px;
  position: relative;
  z-index: 1;
}

nav a:hover {
  color: var(--secondary); /* Blue text on hover */
}

nav a.active {
  background: transparent; /* No background */
  color: var(--secondary); /* Blue text when selected */
}

/* Right section - User info */
.user-section {
  display: flex;
  align-items: center;
  justify-content: flex-end;
}

.user-email {
  color: var(--text);
  margin-right: 1rem;
  font-size: 0.9rem;
}

.logout-btn {
  background: white;
  color: var(--dark);
  border: none;
  border-radius: 4px;
  padding: 0.5rem 1rem;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.logout-btn:hover {
  transform: translateY(-2px);
  background: #f0f0f0;
  box-shadow: 0 7px 20px rgba(0, 0, 0, 0.4);
}

.log-in-btn {
  background-color: rgba(255, 255, 255, 0.1);
  color: var(--text);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  padding: 0.5rem 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  margin-right: 0.5rem;
}

.log-in-btn:hover {
  background-color: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
}

.sign-up-btn {
  background: white;
  color: var(--dark);
  border: none;
  border-radius: 4px;
  padding: 0.5rem 1rem;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.sign-up-btn:hover {
  transform: translateY(-2px);
  background: #f0f0f0;
  box-shadow: 0 7px 20px rgba(0, 0, 0, 0.4);
}

/* Mobile Responsiveness for Header */
@media (max-width: 768px) {
  header {
    flex-direction: column;
    padding: 0.5rem;
  }
  
  .logo-section, .nav-section, .user-section {
    width: 100%;
    display: flex;
    justify-content: center;
    margin: 0.5rem 0;
  }
  
  .logo {
    justify-content: center;
  }
  
  .logo h1 {
    font-size: 2.0rem;
  }
  
  nav {
    justify-content: center;
    flex-wrap: wrap;
    row-gap: 0.5rem;
  }
  
  nav a {
    padding: 0.5rem 0.8rem;
    font-size: 0.9rem;
    margin: 0 0.25rem;
  }
}

/* Profile Styles */
.profile-container {
  max-width: 1000px;
  margin: 2rem auto;
  background: rgb(11, 12, 30);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
}

.profile-container h2 {
  margin-top: 0;
  color: var(--text); /* White heading */
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding-bottom: 1rem;
  font-size: 2.0rem;
  margin-bottom: 2rem;
  position: relative;
  display: inline-block;
  text-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
}

.profile-container h2::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  border-radius: 2px;
}

.profile-section {
  margin-bottom: 2rem;
}

.profile-section h3 {
  color: var(--text); /* White heading */
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  padding-bottom: 0.5rem;
  margin-bottom: 1rem;
  position: relative;
  display: inline-block;
}

.profile-section h3::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  border-radius: 2px;
}

.profile-details {
  background: linear-gradient(to right, rgba(8, 247, 254, 0.1), transparent);
  border: 1px solid rgba(255, 255, 255, 0.1);
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.profile-row {
  display: flex;
  margin-bottom: 1rem;
}

.profile-row:last-child {
  margin-bottom: 0;
}

.profile-label {
  font-weight: bold;
  width: 150px;
  color: var(--text-muted);
}

.teams-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 2rem;
}

.team-card {
  background: rgb(11, 12, 30);
  border-radius: 16px;
  overflow: hidden;
  transition: all 0.3s;
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.team-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
  border-color: rgba(8, 247, 254, 0.3);
}

.team-card-header {
  background: linear-gradient(to right, rgba(8, 247, 254, 0.2), transparent);
  padding: 1.5rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.team-card h4 {
  margin: 0;
  color: var(--text);
  font-size: 1.5rem;
}

.team-card-header .tournament-date {
  font-size: 0.9rem;
  color: var(--text-muted);
}

/* Tournament card styling - keep the placement colors */
.team-card.has-placement::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 5px;
}

.team-card.placement-1::before {
  background-color: #f1c40f; /* Gold */
}

.team-card.placement-2::before {
  background-color: #bdc3c7; /* Silver */
}

.team-card.placement-3::before {
  background-color: #cd7f32; /* Bronze */
}

.team-card.placement-4::before {
  background-color: #3498db; /* Blue */
}

/* Placement badges - keep the medal colors */
.placement-badge {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: bold;
  margin-top: 8px;
}

.placement-badge.gold {
  background-color: #f1c40f;
  color: #0d1023;
}

.placement-badge.silver {
  background-color: #bdc3c7;
  color: #0d1023;
}

.placement-badge.bronze {
  background-color: #cd7f32;
  color: #0d1023;
}

.placement-badge.honorable {
  background-color: #3498db;
  color: #0d1023;
}

/* Enhanced points display */
.points-total {
  display: flex;
  flex-direction: column;
  background-color: rgba(8, 247, 254, 0.1);
  border: 1px solid rgba(8, 247, 254, 0.3);
  border-radius: 8px;
  padding: 1rem;
  margin: 1.5rem;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.points-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.points-label {
  font-size: 0.9rem;
  color: var(--text-muted);
}

.points-value {
  font-weight: bold;
  color: var(--secondary);
}

.points-earned {
  color: var(--secondary);
  font-weight: bold;
  margin-top: 5px;
}

.points-conversion {
  display: flex;
  align-items: center;
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 4px;
  justify-content: space-between;
}

.conversion-arrow {
  margin: 0 5px;
}

.player-avatar-small {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background-color: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.9rem;
  color: var(--text);
  margin-right: 0.5rem;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
}

/* Team players styling */
.team-players-list {
  margin: 0 1.5rem 1.5rem 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  overflow: hidden;
  background-color: rgba(0, 0, 0, 0.2);
}

.team-player {
  display: flex;
  align-items: center;
  padding: 0.8rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.team-player:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.team-player:last-child {
  border-bottom: none;
}

.team-player-info {
  flex: 1;
  color: var(--text);
  font-weight: 500;
}

.team-player-points {
  text-align: right;
  font-weight: bold;
}

.player-points-detail {
  display: flex;
  align-items: center;
  font-size: 0.85rem;
}

.player-points-calculation {
  background-color: rgba(8, 247, 254, 0.1);
  padding: 2px 5px;
  border-radius: 4px;
  margin-left: 5px;
  border: 1px solid rgba(8, 247, 254, 0.2);
}

/* Placement icons - keep the emoji */
.placement-icon {
  display: inline-block;
  margin-left: 5px;
  font-size: 16px;
}

/* Tournament status badge */
.tournament-status {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: bold;
  z-index: 1;
}

.status-completed {
  background-color: rgba(8, 247, 254, 0.2);
  color: var(--secondary);
  border: 1px solid rgba(8, 247, 254, 0.3);
}

.status-active {
  background-color: rgba(254, 83, 187, 0.2);
  color: var(--primary);
  border: 1px solid rgba(254, 83, 187, 0.3);
}

.status-upcoming {
  background-color: rgba(245, 211, 0, 0.2);
  color: var(--accent);
  border: 1px solid rgba(245, 211, 0, 0.3);
}

.status-unknown {
  background-color: rgba(149, 165, 166, 0.2);
  color: #95a5a6;
  border: 1px solid rgba(149, 165, 166, 0.3);
}

/* Winnings badge */
.winnings-badge {
  margin-left: 10px;
  background-color: var(--secondary);
  color: var(--dark);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8rem;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

/* Points details */
.points-earned-label {
  color: var(--secondary);
}

.points-not-earned {
  color: #f82e17;
  text-decoration: line-through;
  opacity: 0.7;
}

.view-results-btn {
  display: inline-block;
  padding: 0.8rem 2rem;
  background: white;
  color: var(--dark);
  border: none;
  border-radius: 6px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  text-align: center;
  width: auto;
  min-width: 200px;
  margin: 0 1.5rem 1.5rem 1.5rem;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.view-results-btn:hover {
  background: #f0f0f0;
  transform: translateY(-5px);
  box-shadow: 0 7px 20px rgba(0, 0, 0, 0.4);
}

/* Animation for the card */
@keyframes highlight-card {
  0% { box-shadow: 0 0 0 0 rgba(8, 247, 254, 0.5); }
  70% { box-shadow: 0 0 0 10px rgba(8, 247, 254, 0); }
  100% { box-shadow: 0 0 0 0 rgba(8, 247, 254, 0); }
}

.team-card.highlight {
  animation: highlight-card 1s ease-in-out;
}

#toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 15px 25px;
  background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
  color: var(--dark);
  border-radius: 6px;
  display: none;
  z-index: 1000;
  box-shadow: 0 5px 15px rgba(138, 43, 226, 0.3);
  max-width: 90%;
  margin: 0 auto;
  left: 0;
  right: 0;
  text-align: center;
  font-weight: 600;
}

/* Loading spinner */
.loading-spinner {
  display: inline-block;
  width: 50px;
  height: 50px;
  border: 3px solid rgba(255,255,255,.3);
  border-radius: 50%;
  border-top-color: var(--secondary);
  animation: spin 1s ease-in-out infinite;
  margin: 1rem auto;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

/* Mobile tap state for better user feedback */
@media (max-width: 768px) {
  a:active, button:active {
    opacity: 0.7;
    transition: opacity 0.1s;
  }
  
  /* Adjust padding for mobile cards */
  .team-card-header {
    padding: 1rem;
  }
  
  .team-player {
    padding: 0.6rem;
  }
  
  .view-results-btn {
    margin: 0 1rem 1rem 1rem;
    padding: 0.7rem 1.5rem;
  }
}
  </style>
</head>
<body>
  <header>
    <div class="logo-section">
      <a href="index.html" class="logo">
        <img src="img/outline.png" alt="Cornhole Kings Logo" width="50" height="50">
        <h1>Cornhole Kings</h1>
      </a>
    </div>
    
    <div class="nav-section">
      <nav>
        <a href="tournaments.html">Tournaments</a>
        <a href="profile.html" class="active">My Profile</a>
        <a href="how-it-works.html">How It Works</a>
        <a href="prizes.html">Prizes</a>
      </nav>
    </div>
    
    <div class="user-section">
      <a href="login.html" class="log-in-btn">Log In</a>
      <a href="signup.html" class="sign-up-btn">Sign Up</a>
    </div>
  </header>
  
  <div class="profile-container">
    <h2>My Profile</h2>
    
    <div class="profile-section">
      <h3>Account Information</h3>
      <div class="profile-details">
        <div class="profile-row">
          <span class="profile-label">Email:</span>
          <span id="userEmail">Loading...</span>
        </div>
        <div class="profile-row">
          <span class="profile-label">Name:</span>
          <span id="userName">Loading...</span>
        </div>
        <div class="profile-row">
          <span class="profile-label">Account Created:</span>
          <span id="userCreated">Loading...</span>
        </div>
      </div>
    </div>
    
    <div class="profile-section">
      <h3>My Teams</h3>
      <div id="userTeams" class="teams-list">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Loading your teams...</p>
        </div>
      </div>
    </div>
  </div>
  
  <div id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/supabase.js"></script>
  <script>
// Helper function to get initials from name
function getInitials(name) {
  if (!name) return 'XX';
  return name
    .split(' ')
    .map(part => part[0])
    .join('')
    .toUpperCase();
}

// Format date helper
function formatDate(dateString) {
  if (!dateString) return 'Unknown Date';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    month: 'long', 
    day: 'numeric', 
    year: 'numeric' 
  });
}

// Helper function to get ordinal suffix (1st, 2nd, 3rd, etc)
function getOrdinal(n) {
  const s = ['th', 'st', 'nd', 'rd'];
  const v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

// Helper function to capitalize the first letter
function capitalizeFirstLetter(string) {
  if (!string) return '';
  return string.charAt(0).toUpperCase() + string.slice(1);
}

document.addEventListener('DOMContentLoaded', function() {
  // Wrap initialization in async function for better error handling
  async function initializeProfilePage() {
    try {
      // Check if user is authenticated
      const user = await getCurrentUser();
      
      if (user) {
        console.log('User authenticated:', user.email);
        
        // Update UI with user information
        await updateUserInterface(user);
        
        // Fetch and display user's teams with improved error handling
        await loadUserTeams(user);
      } else {
        // Not logged in, redirect to login
        console.log('User not logged in, redirecting to login');
        window.location.href = 'login.html?redirect=profile.html';
      }
    } catch (err) {
      console.error('Error initializing profile page:', err);
      showToast('An unexpected error occurred. Please try again later.', 'error');
    }
  }
  
  // Start initialization
  initializeProfilePage();
});

// Update the user interface with user data
async function updateUserInterface(user) {
  try {
    // Update user section in header when logged in
    const userSection = document.querySelector('.user-section');
    userSection.innerHTML = `
      <span class="user-email">${user.email}</span>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    `;
    
    // Add logout event listener
    document.getElementById('logoutBtn').addEventListener('click', async function() {
      try {
        const { error } = await logoutUser();
        if (!error) {
          window.location.reload();
        } else {
          showToast('Error logging out: ' + error.message, 'error');
        }
      } catch (err) {
        console.error('Error during logout:', err);
        showToast('Error during logout', 'error');
      }
    });
    
    // Update profile information
    document.getElementById('userEmail').textContent = user.email || 'Not available';
    document.getElementById('userName').textContent = user.user_metadata?.full_name || 'Not provided';
    document.getElementById('userCreated').textContent = user.created_at ? formatDate(user.created_at) : 'Unknown';
  } catch (err) {
    console.error('Error updating user interface:', err);
    showToast('Error loading user information', 'error');
    // Continue execution despite this error
  }
}

// Enhanced function to load user teams with tournament results
async function loadUserTeams(user) {
  const teamsContainer = document.getElementById('userTeams');
  
  try {
    // First, fetch basic team data - only select fields that definitely exist
    const { data: teams, error: teamsError } = await supabase
      .from('teams')
      .select(`
        id,
        created_at,
        tournament_id,
        team_points
      `)
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });
    
    if (teamsError) {
      console.error('Error fetching teams:', teamsError);
      teamsContainer.innerHTML = '<p>Error loading teams. Please try again later.</p>';
      return;
    }
    
    if (!teams || teams.length === 0) {
      teamsContainer.innerHTML = '<p>You haven\'t created any teams yet.</p>';
      return;
    }
    
    console.log(`Found ${teams.length} teams for user`);
    
    // Create an array to hold all processed teams
    const processedTeams = [];
    
    // Process each team sequentially to avoid race conditions
    for (const team of teams) {
      try {
        // Get tournament details
        const { data: tournament, error: tournamentError } = await supabase
          .from('tournaments')
          .select('name, start_date, status')
          .eq('id', team.tournament_id)
          .single();
        
        if (tournamentError) {
          console.error(`Error fetching tournament for team ${team.id}:`, tournamentError);
          // Continue anyway, we'll just use placeholder text
        }
        
        // Get team players with potential_points
        const { data: teamPlayers, error: playersError } = await supabase
          .from('team_players')
          .select('player_id, potential_points')
          .eq('team_id', team.id);

        if (playersError) {
          console.error(`Error fetching players for team ${team.id}:`, playersError);
          // Continue anyway, we'll just show empty players list
        }

        // Prepare players data
        let players = [];
        let totalPointsEarned = 0;
        let totalPotentialPoints = 0;

        if (teamPlayers && teamPlayers.length > 0) {
          // Get all player IDs
          const playerIds = teamPlayers.map(tp => tp.player_id);
          
          // Fetch player details
          const { data: playerDetails, error: playerDetailsError } = await supabase
            .from('players')
            .select('id, name, profile_picture, rank')
            .in('id', playerIds);
          
          if (playerDetailsError) {
            console.error(`Error fetching player details for team ${team.id}:`, playerDetailsError);
          }
          
          // Get player tournament points
          const { data: playerPoints, error: pointsError } = await supabase
            .from('player_tournament_points')
            .select('player_id, points_earned, placement')
            .eq('tournament_id', team.tournament_id)
            .in('player_id', playerIds);
            
          if (pointsError) {
            console.error(`Error fetching player points for tournament ${team.tournament_id}:`, pointsError);
          }
          
          // Get tournament player information including bracket data
          const { data: tournamentPlayers, error: tournamentPlayersError } = await supabase
            .from('tournament_players')
            .select(`
              player_id,
              bracket_id,
              brackets (name)
            `)
            .eq('tournament_id', team.tournament_id)
            .in('player_id', playerIds);
          
          if (tournamentPlayersError) {
            console.error(`Error fetching tournament players for tournament ${team.tournament_id}:`, tournamentPlayersError);
          }
          
          // Calculate total potential points from team_players data
          totalPotentialPoints = teamPlayers.reduce((sum, tp) => 
            sum + (tp.potential_points || 0), 0);
          
          // Combine player details with team players
          players = teamPlayers.map(tp => {
            const player = playerDetails?.find(p => p.id === tp.player_id) || { 
              name: 'Unknown Player'
            };
            
            // Get bracket data for this player
            const tournamentPlayer = tournamentPlayers?.find(tp => tp.player_id === player.id);
            const bracketName = tournamentPlayer?.brackets?.name || '';
            
            // Use potential_points from team_players
            const potentialPoints = tp.potential_points || 0;
            
            // Find player points from player_tournament_points
            const playerResult = playerPoints?.find(pp => pp.player_id === tp.player_id);
            const hasPlaced = playerResult && playerResult.placement > 0 && playerResult.placement <= 4;
            const pointsEarned = hasPlaced ? (playerResult.points_earned || 0) : 0;
            
            // Add to total points earned
            totalPointsEarned += pointsEarned;
            
            return {
              ...tp,
              potential_points: potentialPoints,
              bracket: bracketName,
              player_details: {
                ...player,
                hasPlaced,
                pointsEarned,
                placement: playerResult?.placement,
                bracket: bracketName
              }
            };
          });
          
          // Update team points calculation
          team.total_potential_points = totalPotentialPoints;
          team.total_points_earned = totalPointsEarned;
        }
        
        // Assemble complete team data
        processedTeams.push({
          ...team,
          tournament: tournament || { name: 'Unknown Tournament', start_date: null, status: 'unknown' },
          players: players,
          isCompleted: tournament?.status === 'completed'
        });
      } catch (err) {
        console.error(`Error processing team ${team.id}:`, err);
        // Continue to next team
      }
    }
    
    // Now render all teams to the DOM
    renderTeams(processedTeams, teamsContainer);
  } catch (err) {
    console.error('Error loading user teams:', err);
    teamsContainer.innerHTML = '<p>Error loading teams. Please try again later.</p>';
    showToast('Error loading teams', 'error');
  }
}
function renderTeams(teams, container) {
  try {
    // Clear loading message
    container.innerHTML = '';
    
    // Create and append each team element
    teams.forEach(team => {
      const teamElement = document.createElement('div');
      teamElement.className = 'team-card';
      
      // Add placement class if any player in the team has placed
      const hasAnyPlayerPlaced = team.players.some(player => player.player_details.hasPlaced);
      if (hasAnyPlayerPlaced) {
        teamElement.classList.add('has-placed-players');
      }
      
      // Create team card header
      const header = document.createElement('div');
      header.className = 'team-card-header';
      
      const heading = document.createElement('h4');
      heading.textContent = team.tournament?.name || 'Unknown Tournament';
      
      const date = document.createElement('div');
      date.className = 'tournament-date';
      date.textContent = formatDate(team.tournament?.start_date);
      
      header.appendChild(heading);
      header.appendChild(date);
      teamElement.appendChild(header);
      
      // Add tournament status badge
      const statusBadge = document.createElement('div');
      statusBadge.className = `tournament-status status-${team.tournament?.status || 'unknown'}`;
      statusBadge.textContent = capitalizeFirstLetter(team.tournament?.status || 'Unknown');
      teamElement.appendChild(statusBadge);
      
      // Add points information
      const pointsInfo = document.createElement('div');
      pointsInfo.className = 'points-total';
      
      // Calculate points safely
      const totalPotentialPoints = team.total_potential_points || 0;
      const totalPointsEarned = team.total_points_earned || 0;
      
      if (team.isCompleted && totalPointsEarned > 0) {
        // Calculate percentage of points earned vs potential points
        const percentEarned = totalPotentialPoints > 0 ? 
          (totalPointsEarned / totalPotentialPoints * 100) : 0;
        
        pointsInfo.innerHTML = `
          <div class="points-summary">
            <span class="points-label">Potential Points:</span>
            <span class="points-value">${totalPotentialPoints}</span>
          </div>
          <div class="points-summary">
            <span class="points-label">Points Earned:</span>
            <span class="points-value points-earned">${totalPointsEarned}</span>
          </div>
          <div class="points-conversion">
            <span>${totalPotentialPoints}</span>
            <span class="conversion-arrow">→</span>
            <span>${totalPointsEarned}</span>
            <span>(${Math.round(percentEarned)}%)</span>
          </div>
        `;
      } else {
        pointsInfo.innerHTML = `<div class="points-summary">
          <span class="points-label">Potential Points:</span>
          <span class="points-value">${totalPotentialPoints}</span>
        </div>`;
      }
      
      teamElement.appendChild(pointsInfo);
      
      // Format players list
      const playersList = document.createElement('div');
      playersList.className = 'team-players-list';
      
      if (team.players && team.players.length > 0) {
        team.players.forEach(player => {
          const playerElement = document.createElement('div');
          playerElement.className = 'team-player';
          
          // Player info section
          const playerInfo = document.createElement('div');
          playerInfo.className = 'team-player-info';
          
          // Create a wrapper for the player name and bracket info
          const playerInfoContent = document.createElement('div');
          playerInfoContent.className = 'player-info-content';
          
          // Player name
          const playerName = document.createElement('div');
          playerName.textContent = player.player_details.name;
          playerInfoContent.appendChild(playerName);
          
          // Add bracket link - using the player's bracket info
          // Get the bracket from player data
          let bracketLetter = 'Unknown';
          let bracketId = '';
          
          // Check if there's bracket information in player metadata or attributes
          // We'll extract this from the dataset or player details
          if (player.bracket) {
            bracketLetter = player.bracket;
          } else if (player.player_details.bracket) {
            bracketLetter = player.player_details.bracket;
          }
          
          // Determine the bracket ID based on the bracket letter
          // These should match your ACL bracket IDs from the first file
          switch(bracketLetter.toUpperCase()) {
            case 'A':
              bracketId = '207800';
              break;
            case 'B':
              bracketId = '207801';
              break;
            case 'C':
              bracketId = '207802';
              break;
            case 'D':
              bracketId = '207803';
              break;
            default:
              // If we don't have a valid bracket, we'll still show something
              bracketId = '207800'; // Default to Bracket A if unknown
          }
          
          // Create bracket link element
          const bracketLink = document.createElement('a');
          bracketLink.href = `https://app.iplayacl.com/bracket-stack-viewer/${bracketId}`;
          bracketLink.className = 'player-bracket-link';
          bracketLink.textContent = `Bracket ${bracketLetter}`;
          bracketLink.target = '_blank'; // Open in new tab
          playerInfoContent.appendChild(bracketLink);
          
          playerInfo.appendChild(playerInfoContent);
          
          // Add a medal icon ONLY for players who placed
          if (player.player_details.hasPlaced) {
            const placementIcon = document.createElement('span');
            placementIcon.className = 'placement-icon';
            
            const placement = player.player_details.placement;
            if (placement === 1) {
              placementIcon.innerHTML = '🥇';
              placementIcon.title = '1st Place';
            } else if (placement === 2) {
              placementIcon.innerHTML = '🥈';
              placementIcon.title = '2nd Place';
            } else if (placement === 3) {
              placementIcon.innerHTML = '🥉';
              placementIcon.title = '3rd Place';
            } else if (placement === 4) {
              placementIcon.innerHTML = '🏅';
              placementIcon.title = '4th Place';
            }
            
            playerInfo.appendChild(placementIcon);
          }
          
          // Player points
          const playerPoints = document.createElement('div');
          playerPoints.className = 'team-player-points';
          
          // Get potential points safely
          const potentialPoints = player.potential_points || 0;
          
          if (team.isCompleted) {
            if (player.player_details.hasPlaced) {
              // Simply show points earned without multiplier since it's always 100%
              playerPoints.innerHTML = `
                <div class="player-points-detail">
                  <span class="points-earned-label">${player.player_details.pointsEarned} pts earned</span>
                </div>
              `;
            } else {
              playerPoints.innerHTML = `
                <div class="points-not-earned">${potentialPoints} potential pts</div>
              `;
            }
          } else {
            playerPoints.innerHTML = `${potentialPoints} potential pts`;
          }
          
          playerElement.appendChild(playerInfo);
          playerElement.appendChild(playerPoints);
          
          playersList.appendChild(playerElement);
        });
      } else {
        const noPlayers = document.createElement('div');
        noPlayers.textContent = 'No players found for this team';
        noPlayers.style.padding = '0.75rem';
        noPlayers.style.textAlign = 'center';
        noPlayers.style.color = 'rgba(255, 255, 255, 0.6)';
        playersList.appendChild(noPlayers);
      }
      
      // Add players list
      teamElement.appendChild(playersList);
      
      // Add View Results button for completed tournaments
      if (team.tournament?.status === 'completed') {
        const resultsButtonContainer = document.createElement('div');
        resultsButtonContainer.style.textAlign = 'center';
        resultsButtonContainer.style.marginTop = '10px';
        
        const resultsButton = document.createElement('a');
        resultsButton.className = 'view-results-btn';
        resultsButton.href = `tournament-results.html?tournamentId=${team.tournament_id}`;
        resultsButton.textContent = 'View Tournament Results';
        
        resultsButtonContainer.appendChild(resultsButton);
        teamElement.appendChild(resultsButtonContainer);
      }
      
      container.appendChild(teamElement);
    });
    
    // Add CSS for the bracket links if it doesn't exist already
    if (!document.getElementById('bracket-link-style')) {
      const style = document.createElement('style');
      style.id = 'bracket-link-style';
      style.textContent = `
        .player-info-content {
          display: flex;
          flex-direction: column;
        }
        
        .player-bracket-link {
          color: var(--text-muted);
          font-size: 0.8rem;
          text-decoration: underline;
          margin-top: 2px;
          display: inline-block;
          transition: color 0.2s ease;
        }
        
        .player-bracket-link:hover {
          color: var(--secondary);
        }
      `;
      document.head.appendChild(style);
    }
    
  } catch (err) {
    console.error('Error rendering teams:', err);
    container.innerHTML = '<p>Error displaying teams. Please try again later.</p>';
  }
}

// Show toast notification
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  
  // Set color based on message type
  if (type === 'success') {
    toast.style.backgroundColor = 'rgba(46, 204, 113, 0.9)';
  } else if (type === 'error') {
    toast.style.backgroundColor = 'rgba(231, 76, 60, 0.9)';
  } else if (type === 'info') {
    toast.style.backgroundColor = 'rgba(52, 152, 219, 0.9)';
  }
  
  toast.style.display = 'block';
  
  setTimeout(() => {
    toast.style.display = 'none';
  }, 3000);
}
  </script>
</body>
</html>